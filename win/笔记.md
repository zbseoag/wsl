rabbitmqctl 服务管理
rabbitmq-diagnostics 诊断和健康检查
rabbitmq-plugins 插件管理
rabbitmq 维护任务队列
rabbitmq-upgrade 升级维护



sudo apt install -y \
   autoconf \
   dpkg-dev \
   file \
   g++ \
   gcc \
   libc6-dev \
   make \
   pkg-config \
   re2c \
   ca-certificates \
   curl \
   xz-utils \
   libargon2-dev \
   libcurl4-openssl-dev \
   libedit-dev \
   libonig-dev \
   libsodium-dev \
   libsqlite3-dev \
   libssl-dev \
   libxml2-dev \
   zlib1g-dev \
   libfreetype6-dev \
   libjpeg-turbo8-dev \
   libpng-dev \
   libzip-dev \



./configure --prefix=/d/usr/nginx \
 --user=zbseoag \
 --group=zbseoag \
 --with-select_module \
 --without-select_module \
 --with-poll_module \
 --without-poll_module \
 --with-threads \
 --with-file-aio \
 --with-http_ssl_module \
 --with-http_v2_module \
 --with-http_realip_module \
 --with-http_addition_module \
 --with-http_xslt_module \
 --with-http_xslt_module=dynamic \
 --with-http_image_filter_module \
 --with-http_image_filter_module=dynamic \
 --with-http_sub_module \
 --with-http_dav_module \
 --with-http_flv_module \
 --with-http_mp4_module \
 --with-http_gunzip_module \
 --with-http_gzip_static_module \
 --with-http_auth_request_module \
 --with-http_random_index_module \
 --with-http_secure_link_module \
 --with-http_degradation_module \
 --with-http_slice_module \
 --with-http_stub_status_module \
 --with-http_perl_module \
 --with-http_perl_module=dynamic \
 --with-mail \
 --with-mail=dynamic \
 --with-mail_ssl_module \
 --with-stream \
 --with-stream=dynamic \
 --with-stream_ssl_module \
 --with-stream_realip_module \
 --with-stream_ssl_preread_module \
 --with-compat \
 --with-pcre \
 --with-pcre-jit \
 --with-libatomic \
 --with-debug 


docker run --network=network --restart=on-failure:1 -d --name=mysql -e MYSQL_ROOT_PASSWORD=123456 -p 3306:3306  mysql:5.6
docker run --network=network --restart=on-failure:1 -d --name=redis -p 6379:6379  redis:6.0
docker run --network=network --restart=on-failure:1 -d --name php7 -w /e -v /e:/e -p 9000:9000 php:7.3-fpm

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Discardable\PostSetup\ShellNew\Classes

sed -i "s/deb.debian.org/mirrors.aliyun.com/g" /etc/apt/sources.list && apt update && apt upgrade -y


php docker 安装插件
sed -i "s/deb./mirrors.aliyun.com/g" /etc/apt/sources.list && apt update
apt install -y libwebp-dev libjpeg-dev libpng-dev libfreetype6-dev libzip-dev libzstd-dev
docker-php-ext-configure gd --with-webp-dir --with-jpeg-dir --with-png-dir --with-freetype-dir
docker-php-ext-install gd pdo pdo_mysql zip

pecl install psr
pecl install phalcon


php think addon -a mydemo -c create




FROM ubuntu
ADD sources.list /etc/apt/
ADD run.sh /home/
RUN apt-get clean && apt-get update
RUN apt-get -y install mysql-server
RUN chmod +x /home/run.sh
EXPOSE 3306 
CMD ["/home/run.sh"]



public function saveAction()
    {
        // Start a transaction
        $this->db->begin();

        $robot = new Robots();

        $robot->name       = "WALL·E";
        $robot->created_at = date("Y-m-d");

        // The model failed to save, so rollback the transaction
        if ($robot->save() === false) {
            $this->db->rollback();
            return;
        }

        $robotPart = new RobotParts();

        $robotPart->robots_id = $robot->id;
        $robotPart->type      = "head";

        // The model failed to save, so rollback the transaction
        if ($robotPart->save() === false) {
            $this->db->rollback();

            return;
        }

        // Commit the transaction
        $this->db->commit();
    }


隐含的事务
$robotPart = new RobotParts();
$robotPart->type = "head";
$robot = new Robots();
$robot->robotPart  = $robotPart;

$robot->name       = "WALL·E";
$robot->created_at = date("Y-m-d");
$robot->save();


use Phalcon\Mvc\Model\Transaction\Failed as TxFailed;
use Phalcon\Mvc\Model\Transaction\Manager as TxManager;

try {
    // Create a transaction manager
    $manager = new TxManager();

    // Request a transaction
    $transaction = $manager->get();

    $robot = new Robots();

    $robot->setTransaction($transaction);

    $robot->name       = "WALL·E";
    $robot->created_at = date("Y-m-d");

    if ($robot->save() === false) {
        $transaction->rollback(
            "Cannot save robot"
        );
    }

    $robotPart = new RobotParts();

    $robotPart->setTransaction($transaction);

    $robotPart->robots_id = $robot->id;
    $robotPart->type      = "head";

    if ($robotPart->save() === false) {
        $transaction->rollback(
            "Cannot save robot part"
        );
    }

    // Everything's gone fine, let's commit the transaction
    $transaction->commit();
} catch (TxFailed $e) {
    echo "Failed, reason: ", $e->getMessage();
}


use Phalcon\Mvc\Model\Transaction\Failed as TxFailed;
use Phalcon\Mvc\Model\Transaction\Manager as TxManager;

try {
    // Create a transaction manager
    $manager = new TxManager();

    // Request a transaction
    $transaction = $manager->get();

    // Get the robots to be deleted
    $robots = Robots::find(
        "type = 'mechanical'"
    );

    foreach ($robots as $robot) {
        $robot->setTransaction($transaction);

        // Something's gone wrong, we should rollback the transaction
        if ($robot->delete() === false) {
            $messages = $robot->getMessages();

            foreach ($messages as $message) {
                $transaction->rollback(
                    $message->getMessage()
                );
            }
        }
    }

    // Everything's gone fine, let's commit the transaction
    $transaction->commit();

    echo "Robots were deleted successfully!";
} catch (TxFailed $e) {
    echo "Failed, reason: ", $e->getMessage();
}


use Phalcon\Mvc\Model\Transaction\Manager as TransactionManager

$di->setShared(
    "transactions",
    function () {
        return new TransactionManager();
    }
);

use Phalcon\Mvc\Controller;
class ProductsController extends Controller
{
    public function saveAction()
    {
        // Obtain the TransactionsManager from the services container
        $manager = $this->di->getTransactions();

        // Or
        $manager = $this->transactions;

        // Request a transaction
        $transaction = $manager->get();

        // ...
    }
}


use Phalcon\Db\Adapter\Pdo\Mysql;
use Phalcon\Db\Adapter\Pdo\PostgreSQL;

$di->set(
    "dbMysql",
    function () {
        return new Mysql(
            [
                "host"     => "localhost",
                "username" => "root",
                "password" => "secret",
                "dbname"   => "invo",
            ]
        );
    }
);

$di->set(
    "dbPostgres",
    function () {
        return new PostgreSQL(
            [
                "host"     => "localhost",
                "username" => "postgres",
                "password" => "",
                "dbname"   => "invo",
            ]
        );
    }
);

namespace Store\Toys;
use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function initialize()
    {
        $this->setConnectionService("dbPostgres");
    }
}


//如果我们希望在应用程序中创建的所有对象都使用相同的EventsManager，则需要将其分配给Models Manager
use Phalcon\Events\Event;
use Phalcon\Events\Manager as EventsManager;
$di->setShared(
    "modelsManager",
    function () {
        $eventsManager = new EventsManager();

        // Attach an anonymous function as a listener for "model" events
        $eventsManager->attach(
            "model:beforeSave",
            function (Event $event, $model) {
                // Catch events produced by the Robots model
                if (get_class($model) === "Store\\Toys\\Robots") {
                    if ($model->name === "Scooby Doo") {
                        echo "Scooby Doo isn't a robot!";

                        return false;
                    }
                }

                return true;
            }
        );

        // Setting a default EventsManager
        $modelsManager = new ModelsManager();

        $modelsManager->setEventsManager($eventsManager);

        return $modelsManager;
    }
);


# 记录SQL
use Phalcon\Logger;
use Phalcon\Events\Manager;
use Phalcon\Logger\Adapter\File as FileLogger;
use Phalcon\Db\Adapter\Pdo\Mysql as Connection;

$di->set(
    "db",
    function () {
        $eventsManager = new EventsManager();

        $logger = new FileLogger("app/logs/debug.log");

        // Listen all the database events
        $eventsManager->attach(
            "db:beforeQuery",
            function ($event, $connection) use ($logger) {
                $logger->log(
                    $connection->getSQLStatement(),
                    Logger::INFO
                );
            }
        );

        $connection = new Connection(
            [
                "host"     => "localhost",
                "username" => "root",
                "password" => "secret",
                "dbname"   => "invo",
            ]
        );

        // Assign the eventsManager to the db adapter instance
        $connection->setEventsManager($eventsManager);

        return $connection;
    }
);



###分析 SQL 语句
use Phalcon\Db\Profiler as ProfilerDb;
use Phalcon\Events\Manager as EventsManager;
use Phalcon\Db\Adapter\Pdo\Mysql as MysqlPdo;

$di->set(
    "profiler",
    function () {
        return new ProfilerDb();
    },
    true
);

$di->set(
    "db",
    function () use ($di) {
        $eventsManager = new EventsManager();

        // Get a shared instance of the DbProfiler
        $profiler = $di->getProfiler();

        // Listen all the database events
        $eventsManager->attach(
            "db",
            function ($event, $connection) use ($profiler) {
                if ($event->getType() === "beforeQuery") {
                    $profiler->startProfile(
                        $connection->getSQLStatement()
                    );
                }

                if ($event->getType() === "afterQuery") {
                    $profiler->stopProfile();
                }
            }
        );

        $connection = new MysqlPdo(
            [
                "host"     => "localhost",
                "username" => "root",
                "password" => "secret",
                "dbname"   => "invo",
            ]
        );

        // Assign the eventsManager to the db adapter instance
        $connection->setEventsManager($eventsManager);

        return $connection;
    }
);

// Send some SQL statements to the database
Robots::find();

Robots::find(
    [
        "order" => "name",
    ]
);

Robots::find(
    [
        "limit" => 30,
    ]
);

// Get the generated profiles from the profiler
$profiles = $di->get("profiler")->getProfiles();

foreach ($profiles as $profile) {
   echo "SQL Statement: ", $profile->getSQLStatement(), "\n";
   echo "Start Time: ", $profile->getInitialTime(), "\n";
   echo "Final Time: ", $profile->getFinalTime(), "\n";
   echo "Total Elapsed Time: ", $profile->getTotalElapsedSeconds(), "\n";
}



trait MyTimestampable
{
    public function beforeCreate()
    {
        $this->created_at = date("r");
    }

    public function beforeUpdate()
    {
        $this->updated_at = date("r");
    }
}


#事务
use Phalcon\Mvc\Model\Transaction\Failed as TxFailed;
use Phalcon\Mvc\Model\Transaction\Manager as TxManager;

try {

    $manager = new TxManager();
    $transaction = $manager->get();

    $robot = new Robots();
    $robot->setTransaction($transaction);

    $robot->name       = "WALL·E";
    $robot->created_at = date("Y-m-d");

    if ($robot->save() === false) {
        $transaction->rollback(
            "Cannot save robot"
        );
    }

    $robotPart = new RobotParts();
    $robotPart->setTransaction($transaction);

    $robotPart->robots_id = $robot->id;
    $robotPart->type      = "head";
    if ($robotPart->save() === false) {
        $transaction->rollback(
            "Cannot save robot part"
        );
    }
    $transaction->commit();

} catch (TxFailed $e) {
    echo "Failed, reason: ", $e->getMessage();
}



#事务可以用以保证以一致性的方式删除多条记录
use Phalcon\Mvc\Model\Transaction\Failed as TxFailed;
use Phalcon\Mvc\Model\Transaction\Manager as TxManager;

try {

    $manager = new TxManager();
    $transaction = $manager->get();

    // Get the robots to be deleted
    $robots = Robots::find(
        "type = 'mechanical'"
    );

    foreach ($robots as $robot) {
        $robot->setTransaction($transaction);

        // Something's gone wrong, we should rollback the transaction
        if ($robot->delete() === false) {
            $messages = $robot->getMessages();

            foreach ($messages as $message) {
                $transaction->rollback(
                    $message->getMessage()
                );
            }
        }
    }

    // Everything's gone fine, let's commit the transaction
    $transaction->commit();

    echo "Robots were deleted successfully!";
} catch (TxFailed $e) {
    echo "Failed, reason: ", $e->getMessage();
}

#当一个事务处于活动状态时，在整个应用中事务管理器将总是返回这个相同的事务
use Phalcon\Mvc\Model\Transaction\Manager as TransactionManager

$di->setShared(
    "transactions",
    function () {
        return new TransactionManager();
    }
);

use Phalcon\Mvc\Controller;

class ProductsController extends Controller
{
    public function saveAction()
    {
  
        $manager = $this->di->getTransactions();
        // Or
        $manager = $this->transactions;

        $transaction = $manager->get();

    }
}


#数据验证
use Phalcon\Mvc\Model;
use Phalcon\Validation;
use Phalcon\Validation\Validator\Uniqueness;
use Phalcon\Validation\Validator\InclusionIn;

class Robots extends Model
{
    public function validation()
    {
        $validator = new Validation();

        $validator->add(
            "type",
            new InclusionIn(
                [
                    "domain" => [
                        "Mechanical",
                        "Virtual",
                    ]
                ]
            )
        );

        $validator->add(
            "name",
            new Uniqueness(
                [
                    "message" => "The robot name must be unique",
                ]
            )
        );

        return $this->validate($validator);
    }
}


use Phalcon\Mvc\Model;
use Phalcon\Mvc\Model\Message;

class Robots extends Model
{
    public function validation()
    {
        if ($this->type === "Old") {
            $message = new Message(
                "Sorry, old robots are not allowed anymore",
                "type",
                "MyType"
            );

            $this->appendMessage($message);

            return false;
        }

        return true;
    }
}

if ($robot->save() === false) {
  $messages = $robot->getMessages();

  foreach ($messages as $message) {
      echo "Message: ", $message->getMessage();
      echo "Field: ", $message->getField();
      echo "Type: ", $message->getType();
  }
}


use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function getMessages()
    {
        $messages = [];

        foreach (parent::getMessages() as $message) {
            switch ($message->getType()) {
                case "InvalidCreateAttempt":
                    $messages[] = "The record cannot be created because it already exists";
                    break;

                case "InvalidUpdateAttempt":
                    $messages[] = "The record cannot be updated because it doesn't exist";
                    break;

                case "PresenceOf":
                    $messages[] = "The field " . $message->getField() . " is mandatory";
                    break;
                case "ConstraintViolation":
                case "InvalidValue":

            }
        }

        return $messages;
    }
}

#####
$robots = Robots::find();
$robots->setHydrateMode(
    Resultset::HYDRATE_ARRAYS
);

// Return every robot as a stdClass
$robots->setHydrateMode(
    Resultset::HYDRATE_OBJECTS
);



// Return every robot as a Robots instance
$robots->setHydrateMode(
    Resultset::HYDRATE_RECORDS
);


#独立的组件
use Phalcon\Di;
use Phalcon\Mvc\Model;
use Phalcon\Mvc\Model\Manager as ModelsManager;
use Phalcon\Db\Adapter\Pdo\Sqlite;
use Phalcon\Mvc\Model\Metadata\Memory as MetaData;

$di = new Di();

$di->set("db",  new Sqlite(["dbname" => "sample.db", ]));

// Set a models manager
$di->set(
    "modelsManager",
    new ModelsManager()
);

$di->set(
    "modelsMetadata",
    new MetaData()
);

// Create a model
class Robots extends Model
{

}

// Use the model
echo Robots::count();


#查询语言
// Executing a simple query
$query = $this->modelsManager->createQuery("SELECT * FROM Cars");
$cars  = $query->execute();

// With bound parameters
$query = $this->modelsManager->createQuery("SELECT * FROM Cars WHERE name = :name:");
$cars  = $query->execute(
    [
        "name" => "Audi",
    ]
);


#使用原生 SQL
use Phalcon\Mvc\Model;
use Phalcon\Mvc\Model\Resultset\Simple as Resultset;

class Robots extends Model
{
    public static function findByRawSql($conditions, $params = null)
    {
        // A raw SQL statement
        $sql = "SELECT * FROM robots WHERE $conditions";

        // Base model
        $robot = new Robots();

        // Execute the query
        return new Resultset(
            null,
            $robot,
            $robot->getReadConnection()->query($sql, $params)
        );
    }
}

$robots = Robots::findByRawSql(
  "id > ?",
  [
      10
  ]
);


#缓存结果集
use Phalcon\Cache\Frontend\Data as FrontendData;
use Phalcon\Cache\Backend\Memcache as BackendMemcache;

// 设置模型缓存服务
$di->set(
    "modelsCache",
    function () {
        // 默认缓存时间为一天
        $frontCache = new FrontendData(
            [
                "lifetime" => 86400,
            ]
        );

        // Memcached连接配置 这里使用的是Memcache适配器
        $cache = new BackendMemcache(
            $frontCache,
            [
                "host" => "localhost",
                "port" => "11211",
            ]
        );

        return $cache;
    }
);


#这里的MongoDB服务是从服务容器中取得的。默认，Phalcon会使mongo作服务名

// Simple database connection to localhost
$di->set(
    "mongo",
    function () {
        $mongo = new MongoClient();

        return $mongo->selectDB("store");
    },
    true
);

// Connecting to a domain socket, falling back to localhost connection
$di->set(
    "mongo",
    function () {
        $mongo = new MongoClient(
            "mongodb:///tmp/mongodb-27017.sock,localhost:27017"
        );

        return $mongo->selectDB("store");
    },
    true
);

win10专业版用户请依次输入：
slmgr /ipk W269N-WFGWX-YVC9B-4J6C9-T83GX
slmgr /skms kms.03k.org
slmgr /ato


win7 
slmgr /ipk 342DG-6YJR8-X92GV-V7DCV-P4K27 && slmgr /skms kms.03k.org && slmgr /ato


kms.03k.org
kms.chinancce.com
kms.lotro.cc
cy2617.jios.org
kms.shuax.com
kms.luody.info
kms.cangshui.net
zh.us.to
kms.library.hk
xykz.f3322.org
kms.binye.xyz
kms.tttal.com
kms.v0v.bid
kms.moeclub.org
amrice.top
kms.digiboy.ir
kms.lolico.moe
kms8.MSGuides.com
kms9.MSGuides.com

svn
zhengbaoshan hn7812


docker run --name=php --network=host -v /d/etc/php:/usr/local/etc  -v /d:/d -v /e:/e -d php:7.3-fpm

docker run --name=nginx --network=host -v /d/etc/nginx:/etc/nginx -v /d:/d -v /e:/e -d nginx


docker run --network=host --name mysql  -v /d/etc/mysql:/etc/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:8

docker run --network=host --name mysql  -e MYSQL_ROOT_PASSWORD=123456 -d mysql:8.0

use mysql;
update user set plugin='mysql_native_password' where  user='root';

php-fpm:
usermod -u 1000 www-data
groupmod -g 1000 www-data




mysql_secure_installation

[mysqld]
default_authentication_plugin = mysql_native_password

use mysql;
SELECT Host, User, plugin from user;
ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY '123456';
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '123456';
FLUSH PRIVILEGES;
SELECT Host, User, plugin from user;

^;\s+.*\n


docker build -f Dockerfile.php7.3 -t zbseoag/php:7.3 .

INSERT INTO `chanyin.luxecome.com`.`app_version` (`app_version_id`, `app_version_os`, `app_version_code`, `app_version_name`, `app_version_content`, `app_version_is_force`, `app_version_download_url`, `app_version_create_time`, `app_version_update_time`) VALUES (43, 'android', 17, '1.9', '发现新版本，请点击更新', 'N', 'https://a.app.qq.com/o/simple.jsp?pkgname=com.hotniao.live.chanyin', 1610765540, 1611136400);
